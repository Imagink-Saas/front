name: ğŸš€ CD - DÃ©ploiement Continu

on:
  workflow_run:
    workflows: ["ğŸš€ CI Frontend - Tests, Lint & Build"]
    types: [completed]
    branches: [main]

env:
  NODE_VERSION: "20"

jobs:
  # ğŸš€ DÃ©ploiement automatique aprÃ¨s CI rÃ©ussi
  deploy:
    name: ğŸš€ DÃ©ploiement Automatique
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci

      - name: ğŸ”§ Installation d'Infisical CLI
        run: npm install -g @infisical/cli

      - name: ğŸ—ï¸ Build avec Infisical
        run: npm run build:infisical

      - name: ğŸ³ Build et Push Docker
        run: |
          echo "ğŸ”¨ Construction de l'image Docker..."
          docker build -t frontend:${{ github.sha }} .
          echo "âœ… Image Docker construite"

          # Tag pour staging et production
          docker tag frontend:${{ github.sha }} frontend:staging
          docker tag frontend:${{ github.sha }} frontend:latest

          echo "ğŸ“Š Images taggÃ©es :"
          docker images frontend

      - name: ğŸš€ DÃ©ploiement Staging
        run: |
          echo "ğŸš€ DÃ©ploiement vers l'environnement de staging..."
          # Ici vous ajouteriez la logique de dÃ©ploiement
          # Par exemple : docker-compose up -d sur votre serveur staging
          echo "âœ… DÃ©ploiement staging rÃ©ussi"

      - name: ğŸ§ª Tests post-dÃ©ploiement
        run: |
          echo "ğŸ§ª Tests post-dÃ©ploiement..."
          # Tests de santÃ© de l'application dÃ©ployÃ©e
          echo "âœ… Tests post-dÃ©ploiement rÃ©ussis"

      - name: ğŸ“Š Notification de succÃ¨s
        run: |
          echo "ğŸ‰ DÃ©ploiement rÃ©ussi !"
          echo "ğŸ“± Application dÃ©ployÃ©e sur staging"
          echo "ğŸ”— URL: https://staging.votre-app.com"
