name: ğŸš€ CI Frontend - Tests, Lint & Build

on:
  push:
    branches: [main, develop, feature/*]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: "20"

jobs:
  # ğŸ” Ã‰tape 1 : VÃ©rification basique
  basic-check:
    name: ğŸ” VÃ©rification basique
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci

      - name: âœ… VÃ©rification de l'installation
        run: |
          echo "âœ… VÃ©rification de l'installation :"
          echo "ğŸ“ Dossier courant : $(pwd)"
          echo "ğŸ“¦ Node modules : $(ls -la node_modules | wc -l) Ã©lÃ©ments"
          echo "ğŸ”§ Version Node : $(node --version)"
          echo "ğŸ“¦ Version npm : $(npm --version)"
          echo "ğŸ“ Fichiers du projet :"
          ls -la

  # ğŸ—ï¸ Ã‰tape 2 : Build et compilation
  build:
    name: ğŸ—ï¸ Build & Compilation
    runs-on: ubuntu-latest
    needs: [basic-check]

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci

      - name: ğŸ—ï¸ Build de production
        run: npm run build

      - name: ğŸ” VÃ©rification du build
        run: |
          echo "ğŸ“ VÃ©rification des fichiers gÃ©nÃ©rÃ©s :"
          ls -la .next/
          echo "ğŸ“Š Taille du build :"
          du -sh .next/
          echo "ğŸ” VÃ©rification des chunks :"
          ls -la .next/static/chunks/ || echo "Aucun chunk trouvÃ©"

      - name: âœ… Validation du build
        run: |
          if [ -d ".next" ]; then
            echo "âœ… Build rÃ©ussi - dossier .next crÃ©Ã©"
            if [ -f ".next/BUILD_ID" ]; then
              echo "âœ… BUILD_ID gÃ©nÃ©rÃ© : $(cat .next/BUILD_ID)"
            fi
          else
            echo "âŒ Build Ã©chouÃ© - dossier .next manquant"
            exit 1
          fi

  # ğŸ” Ã‰tape 3 : Analyse statique
  lint:
    name: ğŸ” Analyse statique
    runs-on: ubuntu-latest
    needs: [build]

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci

      - name: ğŸ” Linting ESLint
        run: npm run lint

      - name: ğŸ” VÃ©rification TypeScript
        run: npx tsc --noEmit

      - name: ğŸ” VÃ©rification des types Jest
        run: npx tsc --noEmit --project tsconfig.jest.json

  # ğŸ§ª Ã‰tape 4 : Tests unitaires
  test:
    name: ğŸ§ª Tests unitaires
    runs-on: ubuntu-latest
    needs: [lint]

    steps:
      - name: ğŸ“¥ Checkout du code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js ${{ env.NODE_VERSION }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"

      - name: ğŸ“¦ Installation des dÃ©pendances
        run: npm ci

      - name: ğŸ§ª ExÃ©cution des tests Jest
        run: npm test -- --coverage --watchAll=false

      - name: ğŸ“Š VÃ©rification de la couverture
        run: |
          echo "ğŸ“Š Couverture des tests :"
          if [ -f "coverage/lcov-report/index.html" ]; then
            echo "âœ… Rapport de couverture gÃ©nÃ©rÃ©"
            echo "ğŸ“ Dossier coverage crÃ©Ã©"
            ls -la coverage/
          else
            echo "âŒ Rapport de couverture manquant"
            exit 1
          fi
